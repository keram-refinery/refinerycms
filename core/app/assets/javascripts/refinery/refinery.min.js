(function(window, $, undefined){'use strict';var e={name:"refinery",n:function(a,b,c){a=a.split(".");for(var d=this;a.length;)d=d[a.shift()];return new d(b,c)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&!a.hasOwnProperty(c)&&(a[c]=b[c]);return a},flash:function(a,b){var c=$("#flash-container").empty(),c=$("<div/>",{"class":"flash flash-"+a,html:b}).appendTo(c);0===c.find(".flash-close").length&&$("<a/>",{"class":"flash-close",text:"close",href:"#"}).appendTo(c)},validator:{email:RegExp(/^([a-z0-9_\.\-]+)@([\da-z\.\-]+)\.([a-z\.]{2,6})$/i),
url:RegExp(/^(https?|ftp):\/\/([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?$/i),page:RegExp("^(https?://"+document.location.host+"|/[a-z0-9]+)")},provide:function(a,b,c){a=a.split(".");var d=a.shift();for(c=c||window;d;)a.length||"undefined"===b?c=c[d]?c[d]:c[d]={}:c[d]=b,d=a.shift()},pubsub:function(){var a=$({});return{unbind:function(){a.unbind()},subscribe:function(b,c){a.on(b,c)},unsubscribe:function(b,c){a.off(b,c)},publish:function(b,c){a.trigger(b,c)}}}(),xhr:{make:function(a,b,c){return $.ajax({url:a,
data:b,dataType:"JSON"}).fail(function(a,b){e.xhr.error(a,b)}).done(function(a,b,g){e.xhr.success(a,b,g,c)})},processHtml:function(a,b,c){for(var d=a.length-1;0<=d;d--)if("string"===typeof a[d]&&0<b.length)c?b.replaceWith(a[d]):b.html(a[d]);else for(var f in a[d])a[d].hasOwnProperty(f)&&e.c(f,a[d][f])},processMessage:function(a){var b,c=$("#flash-container").empty();if("object"===typeof a)for(b in a)a.hasOwnProperty(b)&&c.append(a[b]);else c.append(a)},error:function(a,b){var c='<b class="'+b+'">'+
a.statusText+"</b>",d;try{d=a.b?a.b:JSON.parse(a.responseText),"string"===typeof d.error&&(c+="! "+d.error)}catch(f){}e.flash("error",c)},success:function(a,b,c,d,f){b=c.getResponseHeader("X-XHR-Redirected-To");a.html&&e.xhr.processHtml(a.html,d,f);a.message&&e.xhr.processMessage(a.message);b&&window.history.pushState({refinery:!0,url:b,prev_url:document.location.href},"",b)}},c:function(a,b){var c=$("#"+a);c.find(".refinery-instance").each(function(){e.Object.unbind($(this))});c.html(b)},spinner:{on:function(){var a=
$("body");a.addClass("loading");a.prop("aria-busy",!0)},off:function(){var a=$("body");a.removeClass("loading");a.prop("aria-busy",!1)}}};e.provide("refinery",e);e.ObjectState=function(a){a=a||{};this.a=$.extend(a,this.a)};
e.ObjectState.prototype={a:{},_initialisable:function(){return!(this.get("initialising")||this.get("initialised"))},set:function(a,b){var c;if("object"===typeof a)for(c in a)a.hasOwnProperty(c)&&(this.a[c]=!!a[c]);else this.a[a]="undefined"===typeof b?!0:!!b},get:function(a){return!!this.a[a]},toggle:function(a){var b;for(b=arguments.length-1;0<=b;b--)this.a[arguments[b]]=!this.a[arguments[b]]},is:function(a){return!!(this.a[a]||this["_"+a]&&this["_"+a]())}};e.Object=function(a,b){this.id=e.Object.guid++;this.options=$.extend({},this.options,a);this.uid=this.name+this.id;b||(this.state=new this.State,e.Object.instances.add(this))};
e.Object.prototype={id:0,name:"Object",version:"0.1",module:"refinery",options:null,events:null,holder:null,fullname:"refinery.Object",State:e.ObjectState,state:null,is:function(a,b){if("undefined"===typeof b&&"object"!==typeof a)return this.state.is(a);this.state.set(a,b)},on:function(a,b){var c=this.events||{};c[a]=c[a]||[];c[a].push(b);this.events=c;return this},off:function(a,b){var c=this.events;c&&(c[a]&&c[a]instanceof Array)&&c[a].splice(c[a].indexOf(b),1);return this},subscribe:function(a,
b){e.pubsub.subscribe(this.uid+"."+a,b);return this},unsubscribe:function(a,b){e.pubsub.unsubscribe(this.uid+"."+a,b);return this},trigger:function(a,b){var c=this.events,d;b=!b||b instanceof Array?b:[b];if(c&&c[a])for(c=c[a],d=c.length-1;0<=d&&!1!==c[d].apply(this,b);d--);e.pubsub.publish(this.uid+"."+a,b);return this},destroy:function(a){this.holder.unbind();this.state=this.holder=null;a&&e.Object.instances.remove(this.uid);this.trigger("destroy");this.events={}},init:function(a){this.is("initialisable")&&
(this.holder=a,this.is("initialised",!0),this.trigger("init"));return this}};e.Object.guid=0;
e.Object.create=function(a){var b,c,d,f=["objectPrototype","objectConstructor","objectMethods","id","uid"];a=a||{};d=a.objectMethods;b=a.objectConstructor||function(a,b){e.Object.call(this,a,b)};b.prototype=a.objectPrototype||new e.Object(null,!0);a.module=a.module?"refinery."+a.module:b.prototype.module;a.fullname=a.module+"."+a.name;e.provide(a.fullname,b);for(c in a)a.hasOwnProperty(c)&&-1===f.indexOf(c)&&(b.prototype[c]=a[c]);if(d)for(c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);return b};
e.Object.attach=function(a,b){var c=b.data("refinery-instances")||[];b.data("refinery-instances",c.concat(a));b.addClass("refinery-instance")};e.Object.detach=function(a,b){var c=b.data("refinery-instances")||[];b.data("refinery-instances",c.filter(function(b){return b!==a}));0===b.data("refinery-instances").length&&b.removeClass("refinery-instance")};e.Object.unbind=function(a){a.data("refinery-instances",[]);a.removeClass("refinery-instance")};
e.Object.instances=function(){var a={};return{all:function(){return a},add:function(b){a[b.uid]=b},get:function(b){return a[b]},remove:function(b){delete a[b]}}}();}(window, jQuery));
