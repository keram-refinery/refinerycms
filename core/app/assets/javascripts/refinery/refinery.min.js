(function(window, $){'use strict';(function(){function d(){return d.b.apply(d,arguments)}d.b=function(a,b,c){a=a.split(".");for(var e=this;a.length;)e=e[a.shift()];return new e(b,c)};d.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&!a.hasOwnProperty(c)&&(a[c]=b[c]);return a};d.flash=function(a,b){var c=$("#flash-container").empty(),c=$("<div/>",{"class":"flash flash-"+a,html:b}).appendTo(c);0===c.find(".flash-close").length&&$("<a/>",{"class":"flash-close",text:"close",href:"#"}).appendTo(c)};d.validator={email:RegExp(/^([a-z0-9_\.\-]+)@([\da-z\.\-]+)\.([a-z\.]{2,6})$/i),
url:RegExp(/^(https?|ftp):\/\/([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?$/i),page:RegExp("^(https?://"+document.location.host+"|/[a-z0-9]+)")};d.provide=function(a,b,c){a=a.split(".");var e=a.shift();for(c=c||window;e;)a.length||"undefined"===b?c=c[e]?c[e]:c[e]={}:c[e]=b,e=a.shift()};d.pubsub=function(){var a=$({});return{unbind:function(){a.unbind()},subscribe:function(b,c){a.on(b,c)},unsubscribe:function(b,c){a.off(b,c)},publish:function(b,c){a.trigger(b,c)}}}();d.xhr={make:function(a,b,c){return $.ajax({url:a,
data:b,dataType:"JSON"}).fail(function(a,b){d.xhr.error(a,b)}).done(function(a,b,g){d.xhr.success(a,b,g,c)})},processHtml:function(a,b,c){for(var e=a.length-1;0<=e;e--)if("string"===typeof a[e]&&0<b.length)c?b.replaceWith(a[e]):b.html(a[e]);else for(var f in a[e])a[e].hasOwnProperty(f)&&d.d(f,a[e][f])},processMessage:function(a){var b,c=$("#flash-container").empty();if("object"===typeof a)for(b in a)a.hasOwnProperty(b)&&c.append(a[b]);else c.append(a)},error:function(a,b){var c='<b class="'+b+'">'+
a.statusText+"</b>",e;try{e=a.c?a.c:JSON.parse(a.responseText),"string"===typeof e.error&&(c+="! "+e.error)}catch(f){}d.flash("error",c)},success:function(a,b,c,e,f){b=c.getResponseHeader("X-XHR-Redirected-To");a.html&&d.xhr.processHtml(a.html,e,f);a.message&&d.xhr.processMessage(a.message);b&&window.history.pushState({refinery:!0,url:b,prev_url:document.location.href},"",b)}};d.d=function(a,b){$("#"+a).html(b)};d.spinner={on:function(){$("body").addClass("loading").prop("aria-busy",!0)},off:function(){$("body").removeClass("loading").prop("aria-busy",
!1)}};d.provide("refinery",d)})();(function(d){d.ObjectState=function(a){a=a||{};this.a=$.extend(a,this.a)};d.ObjectState.prototype={a:{},_initialisable:function(){return!(this.get("initialising")||this.get("initialised"))},set:function(a,b){var c;if("object"===typeof a)for(c in a)a.hasOwnProperty(c)&&(this.a[c]=!!a[c]);else this.a[a]="undefined"===typeof b?!0:!!b},get:function(a){return!!this.a[a]},is:function(a){return!!(this.a[a]||this["_"+a]&&this["_"+a]())}}})(refinery);(function(d){d.Object=function(a,b){this.id=d.Object.guid++;this.options=$.extend({},this.options,a);this.uid=this.name+this.id;b||(this.state=new this.State,d.Object.instances.add(this))};d.Object.prototype={id:0,name:"Object",version:"0.1",module:"refinery",options:null,events:null,holder:null,fullname:"refinery.Object",State:d.ObjectState,state:null,is:function(a,b){if(this.state){if("undefined"===typeof b&&"object"!==typeof a)return this.state.is(a);this.state.set(a,b)}},on:function(a,b){var c=
this.events||{};c[a]=c[a]||[];c[a].push(b);this.events=c;return this},off:function(a,b){var c=this.events;c&&(c[a]&&c[a]instanceof Array)&&c[a].splice(c[a].indexOf(b),1);return this},subscribe:function(a,b){d.pubsub.subscribe(this.uid+"."+a,b);return this},unsubscribe:function(a,b){d.pubsub.unsubscribe(this.uid+"."+a,b);return this},trigger:function(a,b){var c=this.events,e;b="undefined"===typeof b||b instanceof Array?b:[b];if(c&&c[a])for(c=c[a],e=c.length-1;0<=e&&!1!==c[e].apply(this,b);e--);d.pubsub.publish(this.uid+
"."+a,b);return this},destroy:function(a){this.holder&&(this.holder.unbind(),this.detach_holder());this.state=null;a&&d.Object.instances.remove(this.uid);this.trigger("destroy");this.events={};return this},_destroy:function(a){return d.Object.prototype.destroy.apply(this,[a])},attach_holder:function(a){var b=a.data("refinery-instances")||[];a.data("refinery-instances",b.concat(this.uid));a.addClass("refinery-instance");this.holder=a},detach_holder:function(){var a=this.holder,b=a.data("refinery-instances")||
[],c=this.uid;a.data("refinery-instances",b.filter(function(a){return a!==c}));0===a.data("refinery-instances").length&&a.removeClass("refinery-instance");this.holder=null},init:function(a){this.is("initialisable")&&(this.holder=a,this.is("initialised",!0),this.trigger("init"));return this}};d.Object.guid=0;d.Object.create=function(a){var b,c,e,f=["objectPrototype","objectConstructor","objectMethods","id","uid"];a=a||{};e=a.objectMethods;b=a.objectConstructor||function(a,b){d.Object.call(this,a,b)};
b.prototype=a.objectPrototype||new d.Object(null,!0);a.module=a.module?"refinery."+a.module:b.prototype.module;a.fullname=a.module+"."+a.name;d.provide(a.fullname,b);for(c in a)a.hasOwnProperty(c)&&-1===f.indexOf(c)&&(b.prototype[c]=a[c]);if(e)for(c in e)e.hasOwnProperty(c)&&(b[c]=e[c]);return b};d.Object.unbind=function(a){for(var b=a.data("refinery-instances",[]),c,e=b.length-1;0<=e;e--)(c=d.Object.instances.get(b[e]))&&c.destroy(!0);a.removeClass("refinery-instance")};d.Object.instances=function(){var a=
{};return{all:function(){return a},add:function(b){a[b.uid]=b},get:function(b){return a[b]},remove:function(b){delete a[b]}}}()})(refinery);}(window, jQuery));
