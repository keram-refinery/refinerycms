(function(window, $, refinery){'use strict';refinery.admin={ui:{}};refinery.Object.create({name:"Form",module:"admin",N:function(a){var b={},c=a.attr("href"),d=this;b[t("refinery.admin.form_unsaved_save_and_continue")]=function(){var a=d.holder,b=$(this),g=c.match(/\?[^\?]+$/)[0];$.ajax({url:a.attr("action"),method:a.attr("method"),data:a.serialize(),dataType:"JSON",success:function(d,k,l){var m=l.getResponseHeader("X-XHR-Redirected-To");b.dialog("close");b.dialog("destroy");m?Turbolinks.visit(m+g):"error"===k?refinery.xhr.success(d,k,l,a,!0):Turbolinks.visit(c)}})};
b[t("refinery.admin.form_unsaved_continue")]=function(){Turbolinks.visit(c)};b[t("refinery.admin.form_unsaved_cancel")]=function(){$(this).dialog("close");$(this).dialog("destroy")};$("<div/>",{html:t("refinery.admin.form_unsaved_html")}).dialog({resizable:!1,height:140,modal:!0,title:t("refinery.admin.form_unsaved_title"),buttons:b})},C:function(){var a=this,b=a.holder;b.find(".image-picker").each(function(){refinery("admin.ImagePicker").init($(this))});b.find(".resource-picker").each(function(){refinery("admin.ResourcePicker").init($(this))});
b.on("click",".locale-picker a",function(c){var d=$(this);if(a.m===b.serialize())return!0;c.preventDefault();c.stopPropagation();a.N(d);return!1})},A:function(){var a=this,b=a.holder,c=b.find(".form-actions .submit-button"),d=c.val();b.on("change","input, select, textarea",function(){a.m!==b.serialize()&&"!"!==d[d.length]?c.val(d+" !"):c.val(d.replace(/ !$/,""))})},l:function(a,b,c){c=c.scrollTop()+c.height();b=b.position().top;c<b?a.addClass("fly"):a.removeClass("fly")},w:function(){function a(){b.l(e,
d,c)}var b=this,c=$(window),d=b.holder.find(".form-actions"),e=b.holder.find(".form-actions-left");0<b.holder.find("textarea").length&&(0<d.length&&0<e.length)&&(b.l(e,d,c),c.on("scroll",a),b.on("destroy",function(){c.unbind("scroll",a)}))},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.C(),this.A(),this.m=a.serialize(),this.w(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});refinery.admin.ui.form=function(a){a.find("form").each(function(){refinery("admin.Form").init($(this))})};refinery.Object.create({name:"FormPageParts",module:"admin",q:"#menu, #add-page-part, #delete-page-part, .locale-picker, .field:not(:has(#page-tabs)), #page-part-editors, #more-options-field, .form-actions",o:function(a){var b=this,c=b.holder,d=c.tabs("option","active"),e=b.b.find(".ui-state-active a").text(),f=$("#page_parts_attributes_"+d+"_id");confirm(t("refinery.admin.form_page_parts_remove",{title:e}))&&(c.find(".ui-tabs-nav li:eq("+d+")").remove(),c.find(".ui-tabs-panel:eq("+d+")").remove(),
c.find(".ui-tabs-nav li a").each(function(a){c.find($(this).attr("href")+" .part-position").val(a)}),c.tabs("refresh"),0<f.length&&$.ajax({url:a+"/"+f.val(),type:"DELETE",dataType:"JSON",success:function(){f.remove();b.trigger("part:delete")}}))},k:function(a,b){var c=this,d=$.trim(b.val()),e=$("#page-part-editors"),f=c.holder.find(".ui-tabs-nav li").length,g="#page_part_"+d.toLowerCase().replace(/\s/g,"_"),h,k;k=function(a){a.html?(h='<li><a href="'+g+'">'+d+"</a></li>",e.append(a.html),c.b.append(h),
c.holder.tabs("refresh"),c.holder.tabs("option","active",f),c.a.dialog("close"),b.val(""),c.trigger("part:add")):refinery.flash("error",t("refinery.xhr_error"))};0<d.length?0===$(g).length?$.getJSON(a,{title:d,part_index:f}).fail(function(){refinery.flash("error",t("refinery.xhr_error"))}).done(function(a){k(a)}):alert(t("refinery.admin.form_page_parts_part_exist")):alert(t("refinery.admin.form_page_parts_title_missing"))},n:function(a,b){var c=this,d=c.a,e=d.find("#new-page-part-title");a.on("click",
function(a){a.preventDefault();d.dialog({title:t("refinery.admin.form_page_parts_add_part_dialog_title"),X:!0,Y:!1,S:!0,width:400,height:240});d.removeClass("hide")});b.on("click",function(a){a.preventDefault();c.o(b.attr("href"))});d.on("click",".cancel-button",function(a){a.preventDefault();d.dialog("close");e.val("")});d.on("click",".submit-button",function(b){b.preventDefault();c.k(a.attr("href"),e)});e.keypress(function(b){13===b.which&&(b.preventDefault(),c.k(a.attr("href"),e))})},r:function(){var a=
$("#add-page-part"),b=$("#delete-page-part");0<a.length&&0<b.length&&(this.a=$("<div/>",{html:'<div class="field">  <input class="larger widest" placeholder="'+t("refinery.admin.label_title")+'" id="new-page-part-title">  <input type="hidden" id="new-page-part-index"></div><div class="form-actions clearfix">  <div class="form-actions-left">    <input type="submit" value="'+t("refinery.admin.button_create")+'" class="button submit-button">  </div></div>'}),this.n(a,b))},L:function(){this.holder.tabs("disable");
this.b.addClass("reordering");this.h.addClass("hide");this.i.removeClass("hide");this.b.sortable("enable");this.j.fadeTo(500,0.3)},M:function(){this.b.removeClass("reordering");this.i.addClass("hide");this.h.removeClass("hide");this.b.sortable("disable");this.j.fadeTo(500,1);this.holder.tabs("enable")},D:function(){var a=this;a.b.sortable({J:"li",enabled:!1,stop:function(){a.holder.find(".ui-tabs-nav li a").each(function(b){a.holder.find($(this).attr("href")+" .part-position").val(b)})}}).sortable("disable");
a.h=$("#reorder-page-part");a.i=$("#reorder-page-part-done");a.h.on("click",function(b){b.preventDefault();a.L()});a.i.on("click",function(b){b.preventDefault();a.M()});a.j=$(a.q)},destroy:function(a){this.is("initialised")&&(this.b=null,this.holder.parent().find("#reorder-page-part, #reorder-page-part-done, #add-page-part, #delete-page-part").off(),this.h=this.i=null,this.a&&(this.a.hasClass("ui-dialog")&&this.a.dialog("destroy"),this.a.off(),this.a.remove(),this.a=null),this.j=null);refinery.Object.prototype.destroy.apply(this,
[a]);return this},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.b=a.find("#page-parts"),this.r(),this.D(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});refinery.admin.ui.formPageParts=function(a,b){a.find("#page-tabs").each(function(){var c=refinery("admin.FormPageParts").init($(this));c.on("part:add",function(){b.reload(a)});c.on("part:delete",function(){b.reload(a)})})};refinery.Object.create({objectConstructor:function(a,b){var c=this;refinery.Object.apply(c,arguments);b||(c.options.nested_sortable.stop=function(a,b){c.options.update_url&&c.update(b.item)})},name:"SortableList",module:"admin",options:{update_url:null,redraw:!0,nested_sortable:{V:"ul",J:"li",W:1}},set:null,html:null,g:function(a){return a.attr("id")&&/([0-9]+)$/.test(a.attr("id"))?a.attr("id").match(/([0-9]+)$/)[1]:null},update:function(a){var b=this,c=b.holder,d=c.nestedSortable("toArray");a={item:{id:b.g(a),
prev_id:b.g(a.prev()),next_id:b.g(a.next()),parent_id:b.g(a.parent().parent())}};b.is("updating")||JSON.stringify(d)===JSON.stringify(b.set)||(b.is({updating:!0,updated:!1}),c.nestedSortable("disable"),refinery.spinner.on(),$.post(b.options.update_url,a,function(a,f,g){"error"===f?c.html(b.html):(b.set=d,b.html=c.html());refinery.xhr.success(a,f,g,c);b.is("updated",!0);b.trigger("update")},b.options.redraw?"JSON":"HTML").fail(function(a){c.html(b.html);refinery.xhr.error(a)}).always(function(){refinery.spinner.off();
b.is("updating",!1);c.nestedSortable("enable")}));return b},destroy:function(a){this.holder.nestedSortable("destroy");this.set=null;this._destroy(a);return this},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),a.nestedSortable(this.options.nested_sortable),this.attach_holder(a),this.set=a.nestedSortable("toArray"),this.html=a.html(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});
refinery.Object.create({objectConstructor:function(a,b){var c=this;refinery.Object.apply(c,arguments);b||(c.options.nested_sortable.stop=function(a,b){c.P(b.item);c.options.update_url&&c.update(b.item)})},objectPrototype:refinery("admin.SortableList",{nested_sortable:{listType:"ul",handle:".move",items:"li",isAllowed:function(a,b,c){return b&&b.text()===c.parent().text()?!1:!0},maxLevels:0}},!0),name:"SortableTree",P:function(a){a=a.parent();this.holder.find(".toggle").each(function(){var a=$(this);
0===a.parent().parent().find("li").length&&a.removeClass("toggle expanded")});a.attr("id")!==this.holder.attr("id")&&(a.addClass("nested data-loaded"),a.parent().find(".icon").first().addClass("toggle expanded"))}});refinery.Object.create({name:"UserInterface",module:"admin",t:function(){this.holder.find("div.checkboxes").each(function(){var a=$(this),b=a.find("input:checkbox").not("[readonly]");1<b.length&&a.find(".checkboxes-cmd."+(b.length===b.filter(":checked").length?"none":"all")).removeClass("hide")})},u:function(){this.holder.find(".collapsible-list").accordion({T:!0,U:"content"})},F:function(){this.holder.find(".sortable-list").each(function(){var a=$(this),b=a.data("sortable-options");a.hasClass("records")?
a.hasClass("tree")?refinery("admin.SortableTree",b).init(a):refinery("admin.SortableList",b).init(a):a.sortable(b)})},v:function(){function a(a){var d=a.closest(".record"),d=0<d.length?d:b.find(".record"),d=0<d.length?d:a.closest("li");0<d.length&&d.fadeOut("normal",function(){d.remove()})}var b=this.holder;b.on("confirm:complete",".records .delete",function(b,d){d&&a($(this))});b.on("click","a.delete",function(){this.hasAttribute("data-confirm")||a($(this))})},O:function(a){var b=a.find(".toggle").first(),
c=a.find(".nested").first();b.hasClass("expanded")?(b.removeClass("expanded"),c.slideUp()):c.hasClass("data-loaded")?(b.addClass("expanded"),c.slideDown()):(a.addClass("loading"),c.load(c.data("ajax-content"),function(){b.addClass("expanded");c.slideDown();a.removeClass("loading");c.hasClass("data-cache")&&c.addClass("data-loaded")}))},G:function(){this.holder.find(".ui-tabs").each(function(){var a=$(this),b=a.find(".ui-tabs-nav .ui-state-active").index();a.tabs({active:-1<b?b:0,activate:function(a,
b){b.newPanel.find("input.text, textarea").focus()}})})},bind_events:function(){var a=this,b=a.holder;b.on("click",".flash-close",function(a){a.preventDefault();$(this).parent().fadeOut();return!1});b.on("click",".tree .toggle",function(b){b.preventDefault();a.O($(this).parents("li:first"))});b.on("ajax:success",function(c,d,e,f){d&&"object"===typeof d&&(c.preventDefault(),refinery.xhr.success(d,e,f,$(c.target),!0),a.reload(b))});b.on("ajax:error",function(a,b,e){refinery.xhr.error(b,e)});b.on("click",
".checkboxes-cmd",function(a){a.preventDefault();a=$(this);var b=a.parent();b.find("input:checkbox").prop("checked",a.hasClass("all"));b.find(".checkboxes-cmd").toggleClass("hide")});b.on("click",".ui-selectable li",function(a){var b=$(this);a.preventDefault();b.parent().hasClass("ui-selectable-multiple")||b.siblings().removeClass("ui-selected");b.toggleClass("ui-selected");return!1})},H:function(){this.holder.on("click",".toggle-hide",function(){var a=$(this);$(a.attr("href")).toggleClass("js-hide");
a.toggleClass("toggle-on")})},I:function(){var a=this.holder,b=refinery.admin.ui,c;this.F();this.G();this.t();this.u();this.H();this.v();for(c in b)if(b.hasOwnProperty(c)&&"function"===typeof b[c])b[c](a,this)},reload:function(a){var b=this.holder.find(".refinery-instance");try{b.each(function(){for(var a=$(this).data("refinery-instances"),b,c=a.length-1;0<=c;c--)b=refinery.Object.instances.get(a[c]),b.destroy(!0)})}catch(c){console.log(c)}this.holder.off();this.state=new this.State;return this.init(a)},
init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.bind_events(),this.I(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});refinery.Object.create({name:"Dialog",module:"admin",options:{title:"",url:null,width:710,modal:!0,autoOpen:!1,autoResize:!0},ui:null,State:function(){function a(a){a=$.extend(a||{},{closed:!0});refinery.ObjectState.call(this,a)}a.prototype={_openable:function(){return this.get("initialised")&&this.get("closed")&&!this.get("opening")},_closable:function(){return!this.get("closing")&&this.get("opened")},_loadable:function(){return!this.get("loading")&&!this.get("loaded")},_submittable:function(){return this.get("initialised")&&
!this.get("submitting")},_insertable:function(){return this.get("initialised")&&!this.get("inserting")}};refinery.extend(a.prototype,refinery.ObjectState.prototype);return a}(),close:function(){this.is("closable")&&this.holder.dialog("close");return this},open:function(){this.is("openable")&&(this.is("opening",!0),this.holder.dialog("open"));return this},submit:function(){var a=this.holder.find("form");0<a.length&&this.submit_form(a);return this},submit_button:function(){},submit_form:function(a){var b=
this;b.is("submittable")&&(b.is("submitting",!0),$.ajax({url:a.attr("action"),type:a.attr("method"),data:a.serialize(),dataType:"JSON"}).done(function(a,d,e){b.xhr_done(a,d,e);b.trigger("submit")}).always(function(){b.is({submitted:!0,submitting:!1})}))},insert:function(){var a=this.holder.find(".ui-selected");0<a.length&&this.trigger("insert",a.data());return this},s:function(){var a=this;a.holder.on("click",".cancel-button, .close-button",function(b){b.preventDefault();a.close();return!1});a.holder.on("click",
".submit-button",function(b){if(0===$(this).closest("form").length)return b.preventDefault(),a.submit_button(),!1});a.holder.on("submit","form",function(b){b.preventDefault();a.submit_form($(this));return!1});a.holder.on("click",".insert-button",function(b){b.preventDefault();a.insert();return!1})},xhr_done:function(a,b,c){var d=this.ui,e=d.holder;refinery.xhr.success(a,b,c,e);d.reload(e)},xhr_fail:function(a,b){refinery.xhr.error(a,b)},B:function(){var a=this;a.holder.on("click",".pagination > a",
function(b){b.preventDefault();$.ajax({url:this.getAttribute("href"),dataType:"JSON"}).fail(refinery.xhr.error).done(function(b,d,e){a.xhr_done(b,d,e)})})},after_load:function(){},load:function(){var a=this,b=a.holder,c=a.options.url,d=$("#frontend_locale");a.is("loadable")&&(a.is("loading",!0),"#"===c[0]?$(function(){b.html($(c).html());a.is({loaded:!0,loading:!1});a.after_load();a.trigger("load")}):(d={id:a.id,frontend_locale:0<d.length?d.val():"en"},d=$.ajax(c,d),d.fail(function(){b.html($("<div/>",
{"class":"flash error",html:t("refinery.admin.dialog_content_load_fail")}))}),d.always(function(){a.is("loading",!1);b.removeClass("loading")}),d.done(function(c,d,g){var h;"success"===d&&(b.empty(),h=$("<div/>").appendTo(b),refinery.xhr.success(c,d,g,h),a.ui.init(h),a.is("loaded",!0),a.after_load(),a.trigger("load"))})));return this},bind_events:function(){var a=this;a.on("insert",a.close);a.on("open",a.load);a.holder.on("dialogopen",function(){a.state.toggle("opening","opened","closed");a.trigger("open")});
a.holder.on("dialogbeforeclose",function(){a.is("closing",!0);a.state.toggle("closing","closed","opened");a.trigger("close")})},destroy:function(a){this.ui&&(this.ui.destroy(!0),this.ui=null);this._destroy(a);return this},init:function(){this.is("initialisable")&&(this.is("initialising",!0),this.holder=$("<div/>",{id:"dialog-"+this.id,"class":"loading"}),this.attach_holder(this.holder),this.ui=refinery("admin.UserInterface"),this.holder.dialog(this.options),this.bind_events(),this.s(),this.B(),this.is({initialised:!0,
initialising:!1}),this.trigger("init"));return this}});refinery.Object.create({name:"Picker",module:"admin",c:null,e:null,d:null,f:null,dialog:null,open:function(){this.dialog.open();return this},close:function(){this.dialog.close();return this},insert:function(a){console.log(a);return this},bind_events:function(){var a=this,b=a.holder;a.dialog.on("insert",function(b){a.insert(b)});b.find(".current-record-link").on("click",function(b){b.preventDefault();a.open()});b.find(".remove-picked-record").on("click",function(b){b.preventDefault();a.c.val("");a.e.empty();
a.f.addClass("hide");a.d.removeClass("hide");a.trigger("remove")})},init:function(a,b){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.c=a.find(".current-record-id"),this.e=a.find(".record-holder"),this.d=a.find(".no-picked-record-selected"),this.f=a.find(".remove-picked-record"),this.dialog=b.init(a),this.bind_events(),this.is({initialised:!0,initialising:!1}),this.is({initialising:!1,initialised:!0}),this.trigger("init"));return this}});refinery.Object.create({objectPrototype:refinery("admin.Dialog",{title:t("refinery.admin.images_dialog_title"),url:"/refinery/dialogs/images"},!0),name:"ImagesDialog",after_load:function(){this.holder.find(".records li").first().addClass("ui-selected");this.holder.find("input.text:visible").focus()},K:function(a){var b=a.find(".ui-selected .image img"),c=a.find(".image-dialog-size.ui-selected a");a=a.find("input:checkbox").is(":checked");var d=null;0<b.length&&(d=b.data(),d.type="library",d.size=
"original",0<c.length&&a&&(d.size=c.data("size"),d.geometry=c.data("geometry")));return d},Q:function(a){a=a.find("input.text:valid").val();var b=null;a&&(b={size:"original",original:a,type:"external"});return b},Z:function(){},insert:function(){var a=this.holder.find('div[aria-expanded="true"]'),b=null;switch(a.attr("id")){case "existing-image-area":b=this.K(a);break;case "external-image-area":b=this.Q(a)}b&&this.trigger("insert",b);return this}});refinery.Object.create({objectPrototype:refinery("admin.Dialog",{title:t("refinery.admin.links_dialog_title"),url:"/refinery/dialogs/links"},!0),name:"LinksDialog",after_load:function(){this.holder.find(".records li").first().addClass("ui-selected")},p:function(a){var b=a.find("#email_address_text:valid"),c=a.find("#email_default_subject_text");a=a.find("#email_default_body_text");var d=b.val(),e=c.val(),f=a.val(),g="?",h="",k=null,e=encodeURIComponent(e),f=encodeURIComponent(f);d&&(0<e.length&&(h+=
g+"subject="+e,g="&"),0<f.length&&(h+=g+"body="+f),k={type:"email",title:d,url:"mailto:"+encodeURIComponent(d)+h},b.val(""),c.val(""),a.val(""));return k},R:function(a){var b=a.find("#web_address_text:valid");a=a.find("#web_address_target_blank");var c=b.val(),d=a.prop("checked"),e=null;c&&(e={type:"website",title:c.replace(/^https?:\/\//,""),url:c,blank:d},b.val("http://"),a.prop("checked",!1));return e},insert:function(){var a=this.holder.find('div[aria-expanded="true"]'),b=null;switch(a.attr("id")){case "links-dialog-pages":b=
a.find(".ui-selected").data("link");b.type="page";break;case "links-dialog-website":b=this.R(a);break;case "links-dialog-email":b=this.p(a)}b&&this.trigger("insert",b);return this}});refinery.Object.create({objectPrototype:refinery("admin.Dialog",{title:t("refinery.admin.resources_dialog_title"),url:"/refinery/dialogs/resources"},!0),name:"ResourcesDialog",after_load:function(){this.holder.find(".records li").first().addClass("ui-selected")},insert:function(){var a=this.holder.find(".ui-selected"),b=null;0<a.length&&(b={id:a.attr("id").replace("dialog-resource-",""),url:a.data("url"),html:a.html(),type:"library"},this.trigger("insert",b));return this}});refinery.Object.create({objectPrototype:refinery("admin.Picker",null,!0),name:"ImagePicker",insert:function(a){a&&(this.c.val(a.id),this.holder.find(".current-image-size").val(a.size),this.e.html($("<img/>",{"class":"size-medium",src:a.medium})),this.d.addClass("hide"),this.f.removeClass("hide"),this.dialog.close(),this.trigger("insert"));return this}});refinery.Object.create({objectPrototype:refinery("admin.Picker",null,!0),name:"ResourcePicker",insert:function(a){a&&(this.c.val(a.id),this.e.html($("<a/>",{src:a.url,html:a.html})),this.d.addClass("hide"),this.f.removeClass("hide"),this.dialog.close(),this.trigger("insert"));return this}});}(window, jQuery, window.refinery));
