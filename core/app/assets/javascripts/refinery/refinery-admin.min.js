(function(window, $){'use strict';refinery.admin={ui:{},backend_path:"/"+document.location.pathname.split("/")[1]};(function(d){d.Object.create({name:"Form",module:"admin",t:function(a){var c={},b=a.attr("href"),e=this;c[t("refinery.admin.form_unsaved_save_and_continue")]=function(){var a=e.holder,c=$(this),h=b.match(/\?[^\?]+$/)[0];$.ajax({url:a.attr("action"),method:a.attr("method"),data:a.serialize(),dataType:"JSON",success:function(e,l,p){var n=/frontend_locale=[\w\-]+/,m=p.getResponseHeader("X-XHR-Redirected-To");c.dialog("close");c.dialog("destroy");m?(b=n.test(m)&&n.test(h)?m.replace(n,h.match(n)[0]):/\?/.test(m)?
m+"&"+h.match(n)[0]:m+h,Turbolinks.visit(b)):"error"===l?d.xhr.success(e,l,p,a,!0):Turbolinks.visit(b)}})};c[t("refinery.admin.form_unsaved_continue")]=function(){$(this).dialog("destroy");Turbolinks.visit(b)};c[t("refinery.admin.form_unsaved_cancel")]=function(){$(this).dialog("close");$(this).dialog("destroy")};$("<div/>",{html:t("refinery.admin.form_unsaved_html")}).dialog({resizable:!1,height:140,modal:!0,title:t("refinery.admin.form_unsaved_title"),buttons:c})},m:function(){var a=this,c=a.holder;
c.find(".image-picker").each(function(){d("admin.ImagePicker").init($(this))});c.find(".resource-picker").each(function(){d("admin.ResourcePicker").init($(this))});c.on("click",".locale-picker a",function(b){var e=$(this);if(a.c===c.serialize())return!0;b.preventDefault();b.stopPropagation();a.t(e);return!1})},r:function(){var a=this.holder,c=$("meta[name=csrf-param]").attr("content"),b=a.find('input[type="file"]');if(0<b.length)a.on("submit",function(e){e.preventDefault();e.stopPropagation();d.spinner.on();
0===a.find('input[name="'+c+'"]').length&&$("<input/>",{name:c,type:"hidden",value:$("meta[name=csrf-token]").attr("content")}).appendTo(a);$.ajax(this.action,{data:a.serializeArray(),files:b,iframe:!0,processData:!1}).done(function(c,b,e){a.trigger("ajax:success",[c,b,e])}).always(function(){d.spinner.off()})})},n:function(){function a(a){a.stopPropagation()}function c(){if(b.is(":valid")){b.removeData("remote");b.removeAttr("data-remote");if(!l||l.closed)l=window.open("",g.attr("href"));b.attr({action:g.attr("href"),
method:"POST",target:g.attr("href")});b.on("submit",a);b.submit();b.off("submit",a);b.attr({action:e,method:k,target:d});h&&(b.attr("data-remote",h),b.data("remote",h))}}var b=this.holder,e=b.attr("action"),d=b.attr("target"),k=b.attr("method"),h=b.data("remote"),g=b.find(".preview-button"),l;0<g.length&&(b.on("click",".preview-button",function(a){a.preventDefault();a.stopPropagation();c()}),b.on("change","input, select, textarea",function(){l&&!l.closed&&c()}))},l:function(){var a=this,c=a.holder,
b=c.find(".form-actions .submit-button"),e;0<b.length&&(e=b.val(),c.on("change","input, select, textarea",function(){a.c!==c.serialize()&&"!"!==e[e.length]?b.val(e+" !"):b.val(e.replace(/ !$/,""))}))},k:function(){function a(){var a=c.scrollTop()+c.height(),d=b.position().top;a<d?e.addClass("fly"):e.removeClass("fly")}var c=$(window),b=this.holder.find(".form-actions"),e=this.holder.find(".form-actions-left");0<this.holder.find("textarea").length&&0<b.length&&0<e.length&&(c.on("scroll",a),this.on("destroy",
function(){c.unbind("scroll",a)}),a())},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.m(),this.l(),this.r(),this.n(),this.c=a.serialize(),this.k(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});d.admin.ui.form=function(a){a.find("form").each(function(){d("admin.Form").init($(this))})}})(refinery);(function(d){d.Object.create({name:"FormPageParts",module:"admin",g:function(){var a=this.holder.find("#page-parts-options").data("page-parts"),c,b;c='<ul class="records">';for(var e=0,d=a.length;e<d;e++)b=a[e],c+='<li data-part="'+b.name+'" class="clearfix" ><label class="stripped"><input type="checkbox"'+(b.active?' checked="1"':"")+'"> '+b.title+'</label> <span class="actions"><span class="icon-small move-icon">'+t("refinery.admin.button_move")+"</span></span></li>";return c+"</ul>"},j:function(){function a(){var a=
[],d,f;e.find("li").each(function(c){var e=$(this),d=e.data("part"),e=e.find("input").is(":checked"),f=b.find('li[aria-controls="page_part_'+d+'"]').detach(),g=$("#page_part_"+d);e?(f.removeClass("js-hide"),g.removeClass("js-hide")):(f.removeClass("ui-tabs-active ui-state-active"),f.addClass("js-hide"),g.addClass("js-hide"));g.find("input.part-active").prop("checked",e);g.find("input.part-position").val(c);"title"!==d&&(a[a.length]=f)});d=0;for(f=a.length;d<f;d++)b.append(a[d]);0===b.find(".ui-tabs-active").length&&
(d=k.index(b.find("li:visible").first()),c.tabs({active:d}))}var c=this.holder,b=this.d,e,d={},k=b.find("li");e=$("<div/>",{html:this.g()});e.on("change","li input",a);e.find("ul").sortable({stop:a});d[t("refinery.admin.button_done")]=function(){a();e.dialog("close")};e.dialog({title:t("refinery.admin.form_page_parts_manage"),modal:!0,resizable:!0,autoOpen:!1,width:400,buttons:d});c.on("click","#page-parts-options",function(a){a.preventDefault();e.dialog("open")});this.a=e},destroy:function(){this.is("initialised")&&
(this.d=null,this.a&&(this.a.dialog("destroy"),this.a.off(),this.a=null));return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.d=a.find(".ui-tabs-nav"),this.j(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});d.admin.ui.formPageParts=function(a){a.find("#page-parts").each(function(){d("admin.FormPageParts").init($(this))})}})(refinery);(function(d){d.Object.create({objectConstructor:function(a,c){var b=this;d.Object.apply(b,arguments);c||(b.options.nested_sortable.stop=function(a,c){b.options.update_url&&b.update(c.item)})},name:"SortableList",module:"admin",options:{update_url:null,redraw:!0,nested_sortable:{A:"ul",w:"li",B:1}},set:null,html:null,b:function(a){return a.attr("id")&&/([0-9]+)$/.test(a.attr("id"))?a.attr("id").match(/([0-9]+)$/)[1]:null},update:function(a){var c=this,b=c.holder,e=b.nestedSortable("toArray");a={item:{id:c.b(a),
prev_id:c.b(a.prev()),next_id:c.b(a.next()),parent_id:c.b(a.parent().parent())}};c.is("updating")||JSON.stringify(e)===JSON.stringify(c.set)||(c.is({updating:!0,updated:!1}),b.nestedSortable("disable"),d.spinner.on(),$.post(c.options.update_url,a,function(a,k,h){"error"===k?b.html(c.html):(c.set=e,c.html=b.html());d.xhr.success(a,k,h,b);c.is("updated",!0);c.trigger("update")},c.options.redraw?"JSON":"HTML").fail(function(a){b.html(c.html);d.xhr.error(a)}).always(function(){d.spinner.off();c.is("updating",
!1);b.nestedSortable("enable")}));return c},destroy:function(){this.holder.nestedSortable("destroy");this.set=null;return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),a.nestedSortable(this.options.nested_sortable),this.attach_holder(a),this.set=a.nestedSortable("toArray"),this.html=a.html(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});d.Object.create({objectConstructor:function(a,c){var b=this;d.Object.apply(b,arguments);
c||(b.options.nested_sortable.stop=function(a,c){b.v(c.item);b.options.update_url&&b.update(c.item)})},objectPrototype:d("admin.SortableList",{nested_sortable:{listType:"ul",handle:".move",items:"li",isAllowed:function(a,c,b){return c&&c.text()===b.parent().text()?!1:!0},maxLevels:0}},!0),name:"SortableTree",v:function(a){a=a.parent();this.holder.find(".toggle").each(function(){var a=$(this);0===a.parent().parent().find("li").length&&a.removeClass("toggle expanded")});a.attr("id")!==this.holder.attr("id")&&
(a.addClass("nested data-loaded"),a.parent().find(".icon").first().addClass("toggle expanded"))}})})(refinery);(function(d){d.Object.create({name:"UserInterface",module:"admin",options:{main_content_selector:"#content"},h:function(){this.holder.find("div.checkboxes").each(function(){var a=$(this),c=a.find("input:checkbox").not("[readonly]");1<c.length&&a.find(".checkboxes-cmd."+(c.length===c.filter(":checked").length?"none":"all")).removeClass("hide")});this.holder.on("click",".checkboxes-cmd",function(a){a.preventDefault();a=$(this);var c=a.parent();c.find("input:checkbox").prop("checked",a.hasClass("all"));
c.find(".checkboxes-cmd").toggleClass("hide")})},i:function(){this.holder.find(".collapsible-list").each(function(){var a=$(this),c=a.data("ui-accordion-options");a.accordion(c)})},o:function(){this.holder.find(".sortable-list").each(function(){var a=$(this),c=a.data("sortable-options");a.hasClass("records")?a.hasClass("tree")?d("admin.SortableTree",c).init(a):d("admin.SortableList",c).init(a):a.sortable(c)})},u:function(a){var c=a.find(".toggle").first(),b=a.find(".nested").first();c.hasClass("expanded")?
(c.removeClass("expanded"),b.slideUp()):b.hasClass("data-loaded")?(c.addClass("expanded"),b.slideDown()):(a.addClass("loading"),b.load(b.data("ajax-content"),function(){c.addClass("expanded");b.slideDown();a.removeClass("loading");b.hasClass("data-cache")&&b.addClass("data-loaded")}))},p:function(){this.holder.find(".ui-tabs").each(function(){var a=$(this),c=a.find(".ui-tabs-nav .ui-state-active").index();a.tabs({active:-1<c?c:0,activate:function(a,c){c.newPanel.find("input.text, textarea").first().focus()}})})},
bind_events:function(){var a=this,c=a.holder;c.on("click",".flash-close",function(a){a.preventDefault();$(this).parent().fadeOut();return!1});c.on("click",".tree .toggle",function(c){c.preventDefault();a.u($(this).parents("li:first"))});c.on("ajax:success",function(b,e,f,k){var h=k.getResponseHeader("X-XHR-Redirected-To"),g=!0;b=b.target;e.redirect_to?Turbolinks.visit(e.redirect_to):(h||"a"===b.tagName.toLowerCase()?(b=c.find(a.options.main_content_selector),g=!1):b=$(b),a.destroy(),d.xhr.success(e,
f,k,b,g),a.trigger("ui:change"))});c.on("ajax:error",function(a,c,f){d.xhr.error(c,f)});c.find(".ui-selectable").selectable({filter:"li"})},q:function(){this.holder.on("click",".toggle-hide",function(){var a=$(this);$(a.attr("href")).toggleClass("js-hide");a.toggleClass("toggle-on")})},s:function(){var a=this.holder,c=d.admin.ui,b;this.o();this.p();this.h();this.i();this.q();for(b in c)if(c.hasOwnProperty(b)&&"function"===typeof c[b])c[b](a,this)},destroy:function(){var a=this.holder;if(a){a=a.find(".refinery-instance");
try{a.each(function(){for(var a=$(this).data("refinery-instances"),c,f=a.length-1;0<=f;f--)c=d.Object.instances.get(a[f]),c.destroy()})}catch(c){d.log(c),d.log(a)}}return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.bind_events(),this.s(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(d){function a(a){a=$.extend(a||{},{closed:!0});d.ObjectState.call(this,a)}a.prototype={_openable:function(){return this.get("initialised")&&this.get("closed")&&!this.get("opening")},_closable:function(){return!this.get("closing")&&this.get("opened")},_loadable:function(){return!this.get("loading")&&!this.get("loaded")},_insertable:function(){return this.get("initialised")&&!this.get("inserting")}};d.extend(a.prototype,d.ObjectState.prototype);d.Object.create({name:"Dialog",module:"admin",
options:{title:"",url:null,width:710,modal:!0,autoOpen:!1,autoResize:!0},ui:null,State:a,close:function(){this.is("closable")&&this.holder.dialog("close");return this},open:function(){this.is("openable")&&(this.is("opening",!0),this.holder.dialog("open"));return this},insert:function(a){var b=a.closest(".ui-tabs-panel"),d;0<b.length&&(b=b.attr("id").replace(/-/g,"_"),"function"===typeof this[b]&&(d=this[b](a)));d&&this.trigger("insert",d);return this},init_buttons:function(){var a=this,b=a.holder;
b.on("click",".cancel-button, .close-button",function(b){b.preventDefault();a.close();return!1});b.on("submit","form",function(b){var d=$(this);d.attr("action")||(b.preventDefault(),b.stopPropagation(),a.insert(d))})},load:function(){var a=this,b=a.holder,e=a.options.url,f=$("#frontend_locale");if(!e)throw Error("Url isn't defined. ("+a.uid+")");a.is("loadable")&&(a.is("loading",!0),f={id:a.id,frontend_locale:0<f.length?f.val():"en"},e=$.ajax(e,f),e.fail(function(){b.html($("<div/>",{"class":"flash error",
html:t("refinery.admin.dialog_content_load_fail")}))}),e.done(function(e,f,g){"success"===f&&(b.empty(),a.f=$("<div/>").appendTo(b),d.xhr.success(e,f,g,a.f),a.e(),a.is("loaded",!0))}),e.always(function(){a.is("loading",!1);b.removeClass("loading");a.trigger("load")}));return this},e:function(){function a(){b.ui&&(b.ui.destroy(),b.ui.unsubscribe("ui:change",a));b.ui=d("admin.UserInterface",{main_content_selector:".dialog-content-wrapper"}).init(b.f);b.ui.subscribe("ui:change",a)}var b=this;a()},bind_events:function(){var a=
this,b=a.holder;a.on("insert",a.close);a.on("open",a.load);b.on("dialogopen",function(){a.is({opening:!1,opened:!0,closed:!1});a.trigger("open")});b.on("dialogbeforeclose",function(){a.is({closing:!1,closed:!0,opened:!1});a.trigger("close")});b.on("selectableselected",".records.ui-selectable",function(b,d){a.insert($(d.selected))});b.on("click",".pagination a",function(a){var c=$(this).attr("href");a.preventDefault();a.stopPropagation();$.get(c).done(function(a,c,d){b.find(".dialog-content-wrapper").trigger("ajax:success",
[a,c,d])}).always(function(){d.spinner.off()})});b.on("ajax:success",function(b,d){a.upload_area(d)})},upload_area:function(){},destroy:function(){this.ui&&(this.ui.destroy(),this.ui.unsubscribe("ui:change",this.e),this.ui=null);this.holder&&this.holder.parent().hasClass("ui-dialog")&&this.holder.dialog("destroy");return this._destroy()},init:function(){var a;this.is("initialisable")&&(this.is("initialising",!0),a=$("<div/>",{id:"dialog-"+this.id,"class":"loading"}),a.dialog(this.options),this.attach_holder(a),
this.bind_events(),this.init_buttons(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(d){d.Object.create({name:"Picker",module:"admin",elm_current_record_id:null,elm_record_holder:null,elm_no_picked_record:null,elm_remove_picked_record:null,dialog:null,open:function(){this.dialog.open();return this},close:function(){this.dialog.close();return this},insert:function(a){d.log(a);return this},bind_events:function(){var a=this,c=a.holder;a.dialog.on("insert",function(b){a.insert(b)});c.find(".current-record-link").on("click",function(b){b.preventDefault();a.open()});c.find(".remove-picked-record").on("click",
function(b){b.preventDefault();a.elm_current_record_id.val("");a.elm_record_holder.empty();a.elm_remove_picked_record.addClass("hide");a.elm_no_picked_record.removeClass("hide");a.trigger("remove")})},init_dialog:function(){},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.elm_current_record_id=a.find(".current-record-id"),this.elm_record_holder=a.find(".record-holder"),this.elm_no_picked_record=a.find(".no-picked-record-selected"),this.elm_remove_picked_record=
a.find(".remove-picked-record"),this.init_dialog(),this.bind_events(),this.is({initialised:!0,initialising:!1}),this.is({initialising:!1,initialised:!0}),this.trigger("init"));return this}})})(refinery);(function(d){d.Object.create({objectConstructor:function(a){a.url=d.admin.backend_path+"/dialogs/image/"+a.image_id;d.Object.apply(this,arguments)},objectPrototype:d("admin.Dialog",{title:t("refinery.admin.image_dialog_title")},!0),name:"ImageDialog",insert:function(a){var c=a.find("#image-alt").val(),b=a.find("#image-id").val(),d=a.find("#image-size .ui-selected a"),f=d.data("size"),d=d.data("geometry");a=a.find("#image-preview").data();this.trigger("insert",{id:b,alt:c,size:f,geometry:d,sizes:a});
return this}})})(refinery);(function(d){d.Object.create({objectPrototype:d("admin.Dialog",{title:t("refinery.admin.images_dialog_title"),url:d.admin.backend_path+"/dialogs/images"},!0),name:"ImagesDialog",existing_image_area:function(a){a.removeClass("ui-selected");return a.data("dialog")},external_image_area:function(a){var c=a.find('input[type="url"]:valid');a=a.find('input[type="text"]:valid');var b=c.val(),d=a.val(),f;b&&(f={url:b,alt:d},c.val(""),a.val(""));return f},upload_area:function(a){a=a.image;var c=this.holder;
a&&(this.trigger("insert",a),c.find("li.ui-selected").removeClass("ui-selected"),c.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(d){d.Object.create({objectPrototype:d("admin.Dialog",{title:t("refinery.admin.pages_dialog_title"),url:d.admin.backend_path+"/dialogs/pages"},!0),name:"PagesDialog",email_link_area:function(a){var c=a.find("#email_address_text:valid"),b=a.find("#email_default_subject_text");a=a.find("#email_default_body_text");var d=c.val(),f=b.val(),k=a.val(),h="?",g="",l;d&&(0<f.length&&(g+=h+"subject="+encodeURIComponent(f),h="&"),0<k.length&&(g+=h+"body="+encodeURIComponent(k)),l={type:"email",title:d,
url:"mailto:"+encodeURIComponent(d)+g},c.val(""),b.val(""),a.val(""));return l},website_link_area:function(a){var c=a.find("#web_address_text:valid");a=a.find("#web_address_target_blank");var b=c.val(),d=a.prop("checked"),f;b&&(f={type:"website",title:b.replace(/^https?:\/\//,""),url:b,blank:d},c.val("http://"),a.prop("checked",!1));return f},pages_link_area:function(a){var c=a.data("dialog");c.type="page";a.removeClass("ui-selected");return c}})})(refinery);(function(d){d.Object.create({objectPrototype:d("admin.Dialog",{title:t("refinery.admin.resources_dialog_title"),url:d.admin.backend_path+"/dialogs/resources"},!0),name:"ResourcesDialog",existing_resource_area:function(a){a.removeClass("ui-selected");return a.data("dialog")},upload_area:function(a){a=a.file;var c=this.holder;a&&(this.trigger("insert",a),c.find("li.ui-selected").removeClass("ui-selected"),c.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(d){d.Object.create({objectPrototype:d("admin.Picker",null,!0),name:"ImagePicker",init_dialog:function(){var a=d("admin.ImagesDialog").init();a.on("load",function(){a.holder.find('a[href="#external-image-area"]').parent().hide()});this.dialog=a},insert:function(a){this.elm_current_record_id.val(a.id);this.elm_record_holder.html($("<img/>",{"class":"record size-medium",src:a.thumbnail}));this.elm_no_picked_record.addClass("hide");this.elm_remove_picked_record.removeClass("hide");this.dialog.close();
this.trigger("insert");return this}})})(refinery);(function(d){d.Object.create({objectPrototype:d("admin.Picker",null,!0),name:"ResourcePicker",init_dialog:function(){this.dialog=d("admin.ResourcesDialog").init()},insert:function(a){var c;c=$("<span/>",{text:a.name+" - "+a.size,"class":"title"+(" "+a.ext||"")});this.elm_current_record_id.val(a.id);this.elm_record_holder.html($("<a/>",{src:a.url,html:c,"class":"record"}));this.elm_no_picked_record.addClass("hide");this.elm_remove_picked_record.removeClass("hide");this.dialog.close();this.trigger("insert");
return this}})})(refinery);}(window, jQuery));
