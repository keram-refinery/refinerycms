(function(window, $){'use strict';refinery.admin={ui:{},backend_path:"/"+document.location.pathname.split("/")[1]};(function(c){c.Object.create({name:"Form",module:"admin",B:function(a){var b={},d=a.attr("href"),e=this;b[t("refinery.admin.form_unsaved_save_and_continue")]=function(){var a=e.holder,b=$(this),h=d.match(/\?[^\?]+$/)[0];$.ajax({url:a.attr("action"),method:a.attr("method"),data:a.serialize(),dataType:"JSON",success:function(e,l,m){var n=m.getResponseHeader("X-XHR-Redirected-To");b.dialog("close");b.dialog("destroy");n?Turbolinks.visit(n+h):"error"===l?c.xhr.success(e,l,m,a,!0):Turbolinks.visit(d)}})};
b[t("refinery.admin.form_unsaved_continue")]=function(){Turbolinks.visit(d)};b[t("refinery.admin.form_unsaved_cancel")]=function(){$(this).dialog("close");$(this).dialog("destroy")};$("<div/>",{html:t("refinery.admin.form_unsaved_html")}).dialog({resizable:!1,height:140,modal:!0,title:t("refinery.admin.form_unsaved_title"),buttons:b})},s:function(){var a=this,b=a.holder;b.find(".image-picker").each(function(){c("admin.ImagePicker").init($(this))});b.find(".resource-picker").each(function(){c("admin.ResourcePicker").init($(this))});
b.on("click",".locale-picker a",function(d){var e=$(this);if(a.h===b.serialize())return!0;d.preventDefault();d.stopPropagation();a.B(e);return!1})},w:function(){var a=this.holder,b=a.find('input[type="file"]');if(0<b.length)a.on("submit",function(d){d.preventDefault();d.stopPropagation();c.spinner.on();$.ajax(this.action,{data:a.serializeArray(),files:b,iframe:!0,processData:!1}).done(function(b,d,c){a.trigger("ajax:success",[b,d,c])}).always(function(){c.spinner.off()})})},q:function(){var a=this,
b=a.holder,d=b.find(".form-actions .submit-button"),e;0<d.length&&(e=d.val(),b.on("change","input, select, textarea",function(){a.h!==b.serialize()&&"!"!==e[e.length]?d.val(e+" !"):d.val(e.replace(/ !$/,""))}))},g:function(a,b,d){d=d.scrollTop()+d.height();b=b.position().top;d<b?a.addClass("fly"):a.removeClass("fly")},p:function(){function a(){b.g(c,e,d)}var b=this,d=$(window),e=b.holder.find(".form-actions"),c=b.holder.find(".form-actions-left");0<b.holder.find("textarea").length&&(0<e.length&&0<
c.length)&&(b.g(c,e,d),d.on("scroll",a),b.on("destroy",function(){d.unbind("scroll",a)}))},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.s(),this.q(),this.w(),this.h=a.serialize(),this.p(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});c.admin.ui.form=function(a){a.find("form").each(function(){c("admin.Form").init($(this))})}})(refinery);(function(c){c.Object.create({name:"FormPageParts",module:"admin",j:function(){var a;a='<ul class="records">';this.f.find("a").each(function(){var b=$(this),d=!b.parent().hasClass("js-hide");a+='<li data-part="'+b.attr("href")+'" ';a+='class="clearfix" >';a+='<label class="stripped">';a+='<input type="checkbox"'+(d?' checked="1"':"")+'"> ';a+=b.text();a+="</label>";a+=' <span class="actions"><span class="icon-small move-icon">';a+=t("refinery.admin.button_move")+"</span></span>";a+="</li>"});return a+=
"</ul>"},n:function(){function a(){var a=[],c,f;e.find("li").each(function(b){var e=$(this),c=e.data("part"),e=e.find("input").is(":checked"),f=d.find('a[href="'+c+'"]').parent().detach(),c=$(c);e?(f.removeClass("js-hide"),c.removeClass("js-hide")):(f.removeClass("ui-tabs-active ui-state-active"),f.addClass("js-hide"),c.addClass("js-hide"));c.find("input.part-active").prop("checked",e);c.find("input.part-position").val(b);a[a.length]=f});c=0;for(f=a.length;c<f;c++)d.append(a[c]);0===d.find(".ui-tabs-active").length&&
(c=g.index(d.find("li:visible").first()),b.tabs({active:c}))}var b=this.holder,d=this.f,e,c={},g=d.find("li");e=$("<div/>",{html:this.j()});e.on("change","li input",a);e.find("ul").sortable({stop:a});c[t("refinery.admin.button_done")]=function(){a();e.dialog("close")};e.dialog({title:t("refinery.admin.form_page_parts_manage"),modal:!0,resizable:!0,autoOpen:!1,width:400,buttons:c});b.on("click","#page-parts-options",function(a){a.preventDefault();e.dialog("open")});this.i=e},destroy:function(a){var b=
this.i;this.is("initialised")&&(this.f=null,b&&(b.parent().hasClass("ui-dialog")&&b.dialog("destroy"),b.off(),b.remove()));this._destroy(a);return this},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.f=a.find(".ui-tabs-nav"),this.n(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});c.admin.ui.formPageParts=function(a){a.find("#page-parts").each(function(){c("admin.FormPageParts").init($(this))})}})(refinery);(function(c){c.Object.create({objectConstructor:function(a,b){var d=this;c.Object.apply(d,arguments);b||(d.options.nested_sortable.stop=function(a,b){d.options.update_url&&d.update(b.item)})},name:"SortableList",module:"admin",options:{update_url:null,redraw:!0,nested_sortable:{K:"ul",J:"li",L:1}},set:null,html:null,e:function(a){return a.attr("id")&&/([0-9]+)$/.test(a.attr("id"))?a.attr("id").match(/([0-9]+)$/)[1]:null},update:function(a){var b=this,d=b.holder,e=d.nestedSortable("toArray");a={item:{id:b.e(a),
prev_id:b.e(a.prev()),next_id:b.e(a.next()),parent_id:b.e(a.parent().parent())}};b.is("updating")||JSON.stringify(e)===JSON.stringify(b.set)||(b.is({updating:!0,updated:!1}),d.nestedSortable("disable"),c.spinner.on(),$.post(b.options.update_url,a,function(a,g,h){"error"===g?d.html(b.html):(b.set=e,b.html=d.html());c.xhr.success(a,g,h,d);b.is("updated",!0);b.trigger("update")},b.options.redraw?"JSON":"HTML").fail(function(a){d.html(b.html);c.xhr.error(a)}).always(function(){c.spinner.off();b.is("updating",
!1);d.nestedSortable("enable")}));return b},destroy:function(a){this.holder.nestedSortable("destroy");this.set=null;this._destroy(a);return this},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),a.nestedSortable(this.options.nested_sortable),this.attach_holder(a),this.set=a.nestedSortable("toArray"),this.html=a.html(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});c.Object.create({objectConstructor:function(a,b){var d=this;c.Object.apply(d,arguments);
b||(d.options.nested_sortable.stop=function(a,b){d.D(b.item);d.options.update_url&&d.update(b.item)})},objectPrototype:c("admin.SortableList",{nested_sortable:{listType:"ul",handle:".move",items:"li",isAllowed:function(a,b,d){return b&&b.text()===d.parent().text()?!1:!0},maxLevels:0}},!0),name:"SortableTree",D:function(a){a=a.parent();this.holder.find(".toggle").each(function(){var a=$(this);0===a.parent().parent().find("li").length&&a.removeClass("toggle expanded")});a.attr("id")!==this.holder.attr("id")&&
(a.addClass("nested data-loaded"),a.parent().find(".icon").first().addClass("toggle expanded"))}})})(refinery);(function(c){c.Object.create({name:"UserInterface",module:"admin",l:function(){this.holder.find("div.checkboxes").each(function(){var a=$(this),b=a.find("input:checkbox").not("[readonly]");1<b.length&&a.find(".checkboxes-cmd."+(b.length===b.filter(":checked").length?"none":"all")).removeClass("hide")});this.holder.on("click",".checkboxes-cmd",function(a){a.preventDefault();a=$(this);var b=a.parent();b.find("input:checkbox").prop("checked",a.hasClass("all"));b.find(".checkboxes-cmd").toggleClass("hide")})},
m:function(){this.holder.find(".collapsible-list").accordion({G:!0,I:"content"})},t:function(){this.holder.find(".sortable-list").each(function(){var a=$(this),b=a.data("sortable-options");a.hasClass("records")?a.hasClass("tree")?c("admin.SortableTree",b).init(a):c("admin.SortableList",b).init(a):a.sortable(b)})},o:function(){function a(a){var c=a.closest(".record"),c=0<c.length?c:b.find(".record"),c=0<c.length?c:a.closest("li");0<c.length&&c.fadeOut("normal",function(){c.remove()})}var b=this.holder;
b.on("confirm:complete",".records .delete",function(b,c){c&&a($(this))});b.on("click","a.delete",function(){this.hasAttribute("data-confirm")||a($(this))})},C:function(a){var b=a.find(".toggle").first(),d=a.find(".nested").first();b.hasClass("expanded")?(b.removeClass("expanded"),d.slideUp()):d.hasClass("data-loaded")?(b.addClass("expanded"),d.slideDown()):(a.addClass("loading"),d.load(d.data("ajax-content"),function(){b.addClass("expanded");d.slideDown();a.removeClass("loading");d.hasClass("data-cache")&&
d.addClass("data-loaded")}))},u:function(){this.holder.find(".ui-tabs").each(function(){var a=$(this),b=a.find(".ui-tabs-nav .ui-state-active").index();a.tabs({active:-1<b?b:0,activate:function(a,b){b.newPanel.find("input.text, textarea").first().focus()}})})},bind_events:function(){var a=this,b=a.holder;b.on("click",".flash-close",function(a){a.preventDefault();$(this).parent().fadeOut();return!1});b.on("click",".tree .toggle",function(b){b.preventDefault();a.C($(this).parents("li:first"))});b.on("ajax:success",
function(d,e,f,g){e&&"object"===typeof e&&(d.preventDefault(),e.redirect_to?Turbolinks.visit(e.redirect_to):(a.destroy(!1),c.xhr.success(e,f,g,$(d.target),!0),a.reload(b)))});b.on("ajax:error",function(a,b,f){c.xhr.error(b,f)});b.find(".ui-selectable").selectable({filter:"li"})},v:function(){this.holder.on("click",".toggle-hide",function(){var a=$(this);$(a.attr("href")).toggleClass("js-hide");a.toggleClass("toggle-on")})},A:function(){var a=this.holder,b=c.admin.ui,d;this.t();this.u();this.l();this.m();
this.v();this.o();for(d in b)if(b.hasOwnProperty(d)&&"function"===typeof b[d])b[d](a,this);a.find("input.text, textarea").first().focus()},reload:function(a){a=a||this.holder;this.destroy(!1);this.state=new this.State;return this.init(a)},destroy:function(a){var b=this.holder;if(b){b=b.find(".refinery-instance");try{b.each(function(){for(var a=$(this).data("refinery-instances"),b,d=a.length-1;0<=d;d--)b=c.Object.instances.get(a[d]),b.destroy(!0)})}catch(d){"object"===typeof console&&"function"===
typeof console.log&&console.log(d)}}this._destroy(a);return this},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.bind_events(),this.A(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(c){c.Object.create({name:"Dialog",module:"admin",options:{title:"",url:null,width:710,modal:!0,autoOpen:!1,autoResize:!0},ui:null,State:function(){function a(a){a=$.extend(a||{},{closed:!0});c.ObjectState.call(this,a)}a.prototype={_openable:function(){return this.get("initialised")&&this.get("closed")&&!this.get("opening")},_closable:function(){return!this.get("closing")&&this.get("opened")},_loadable:function(){return!this.get("loading")&&!this.get("loaded")},_submittable:function(){return this.get("initialised")&&
!this.get("submitting")},_insertable:function(){return this.get("initialised")&&!this.get("inserting")}};c.extend(a.prototype,c.ObjectState.prototype);return a}(),close:function(){this.is("closable")&&this.holder.dialog("close");return this},open:function(){this.is("openable")&&(this.is("opening",!0),this.holder.dialog("open"));return this},submit:function(){this.holder.find("form").submit();return this},submit_form:function(a){var b=this;b.is("submittable")&&(b.is("submitting",!0),$.ajax({url:a.attr("action"),
type:a.attr("method"),data:a.serialize(),dataType:"JSON"}).done(function(a,c,f){b.xhr_done(a,c,f);b.trigger("submit")}).always(function(){b.is({submitted:!0,submitting:!1})}))},insert:function(a){var b,d;0<a.length&&(a=a.closest(".ui-tabs-panel"),0<a.length&&(d=a.attr("id").replace(/-/g,"_"),"function"===typeof this[d]&&(b=this[d](a))));b&&this.trigger("insert",b);return this},k:function(){var a=this,b=a.holder;b.on("click",".cancel-button, .close-button",function(b){b.preventDefault();a.close();
return!1});b.on("submit","form",function(b){var c=$(this);b.preventDefault();b.stopPropagation();c.attr("action")?a.submit_form(c):a.insert(c);return!1})},xhr_done:function(a,b,d){var e=this.ui,f=e.holder;c.xhr.success(a,b,d,f);e.reload(f)},xhr_fail:function(a,b){c.xhr.error(a,b)},r:function(){var a=this;a.holder.on("click",".pagination > a",function(b){b.preventDefault();$.ajax({url:this.getAttribute("href"),dataType:"JSON"}).fail(c.xhr.error).done(function(b,c,f){a.xhr_done(b,c,f)})})},after_load:function(){},
load:function(){var a=this,b=a.holder,d=a.options.url,e=$("#frontend_locale");if(!d)throw Error("Url isn't defined. ("+a.uid+")");a.is("loadable")&&(a.is("loading",!0),e={id:a.id,frontend_locale:0<e.length?e.val():"en"},d=$.ajax(d,e),d.fail(function(){b.html($("<div/>",{"class":"flash error",html:t("refinery.admin.dialog_content_load_fail")}));a.trigger("load",!1)}),d.always(function(){a.is("loading",!1);b.removeClass("loading")}),d.done(function(d,e,h){var k;"success"===e&&(b.empty(),k=$("<div/>").appendTo(b),
c.xhr.success(d,e,h,k),a.ui.init(k),a.is("loaded",!0),a.after_load(),a.trigger("load",!0))}));return this},bind_events:function(){var a=this,b=a.holder;a.on("insert",a.close);a.on("open",a.load);b.on("dialogopen",function(){a.is({opening:!1,opened:!0,closed:!1});a.trigger("open")});b.on("dialogbeforeclose",function(){a.is({closing:!1,closed:!0,opened:!1});a.trigger("close")});b.on("selectableselected",".records.ui-selectable",function(b,c){a.insert($(c.selected))})},destroy:function(a){this.ui&&(this.ui.destroy(!0),
this.ui=null);this.holder&&this.holder.parent().hasClass("ui-dialog")&&this.holder.dialog("destroy");this._destroy(a);return this},init:function(){var a;this.is("initialisable")&&(this.is("initialising",!0),a=$("<div/>",{id:"dialog-"+this.id,"class":"loading"}),a.dialog(this.options),this.attach_holder(a),this.ui=c("admin.UserInterface"),this.bind_events(),this.k(),this.r(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(c){c.Object.create({name:"Picker",module:"admin",a:null,c:null,b:null,d:null,dialog:null,open:function(){this.dialog.open();return this},close:function(){this.dialog.close();return this},insert:function(a){console.log(a);return this},bind_events:function(){var a=this,b=a.holder;a.dialog.on("insert",function(b){a.insert(b)});b.find(".current-record-link").on("click",function(b){b.preventDefault();a.open()});b.find(".remove-picked-record").on("click",function(b){b.preventDefault();a.a.val("");
a.c.empty();a.d.addClass("hide");a.b.removeClass("hide");a.trigger("remove")})},init:function(a,b){this.is("initialisable")&&(this.is("initialising",!0),this.attach_holder(a),this.a=a.find(".current-record-id"),this.c=a.find(".record-holder"),this.b=a.find(".no-picked-record-selected"),this.d=a.find(".remove-picked-record"),this.dialog=b.init(a),this.bind_events(),this.is({initialised:!0,initialising:!1}),this.is({initialising:!1,initialised:!0}),this.trigger("init"));return this}})})(refinery);(function(c){c.Object.create({objectConstructor:function(a){a.url=c.admin.backend_path+"/dialogs/image/"+a.image_id;c.Object.apply(this,arguments)},objectPrototype:c("admin.Dialog",{title:t("refinery.admin.image_dialog_title")},!0),name:"ImageDialog",insert:function(){var a=this.holder,b=a.find("#image-alt").val(),c=a.find("#image-id").val(),e=a.find("#image-size .ui-selected a"),f=e.data("size"),e=e.data("geometry"),a=a.find("#image-preview").data();this.trigger("insert",{id:c,alt:b,size:f,geometry:e,
sizes:a});return this}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Dialog",{title:t("refinery.admin.images_dialog_title"),url:c.admin.backend_path+"/dialogs/images"},!0),name:"ImagesDialog",after_load:function(){var a=this;a.holder.on("ajax:success",function(b,c){a.upload_image_area(c.image)})},existing_image_area:function(a){a=a.find("li.ui-selected");var b;0<a.length&&(b={id:a.attr("id").match(/[0-9]+$/)[0]},a.removeClass("ui-selected"));return b},external_image_area:function(a){var b=a.find('input[type="url"]:valid');
a=a.find('input[type="text"]:valid');var c=b.val(),e=a.val(),f;c&&(f={url:c,alt:e},b.val(""),a.val(""));return f},upload_image_area:function(a){var b=this.holder;a&&(this.trigger("insert",a),b.find("li.ui-selected").removeClass("ui-selected"),b.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Dialog",{title:t("refinery.admin.pages_dialog_title"),url:c.admin.backend_path+"/dialogs/pages"},!0),name:"PagesDialog",H:function(a){var b=a.find("#email_address_text:valid"),c=a.find("#email_default_subject_text");a=a.find("#email_default_body_text");var e=b.val(),f=c.val(),g=a.val(),h="?",k="",l,f=encodeURIComponent(f),g=encodeURIComponent(g);e&&(0<f.length&&(k+=h+"subject="+f,h="&"),0<g.length&&(k+=h+"body="+g),l={type:"email",title:e,url:"mailto:"+
encodeURIComponent(e)+k},b.val(""),c.val(""),a.val(""));return l},O:function(a){var b=a.find("#web_address_text:valid");a=a.find("#web_address_target_blank");var c=b.val(),e=a.prop("checked"),f;c&&(f={type:"website",title:c.replace(/^https?:\/\//,""),url:c,blank:e},b.val("http://"),a.prop("checked",!1));return f},N:function(a){a=a.find("li.ui-selected");var b;0<a.length&&(b=a.data("link"),b.type="page",a.removeClass("ui-selected"));return b}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Dialog",{title:t("refinery.admin.resources_dialog_title"),url:c.admin.backend_path+"/dialogs/resources"},!0),name:"ResourcesDialog",after_load:function(){var a=this;a.holder.on("ajax:success",function(b,c){a.F(c.file)})},existing_resource_area:function(a){a=a.find("li.ui-selected");if(0<a.length)return a.removeClass("ui-selected"),a.data("dialog")},F:function(a){var b=this.holder;a&&(this.trigger("insert",a),b.find("li.ui-selected").removeClass("ui-selected"),
b.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Picker",null,!0),name:"ImagePicker",insert:function(a){a&&(this.a.val(a.id),this.holder.find(".current-image-size").val(a.size),this.c.html($("<img/>",{"class":"size-medium",src:a.M})),this.b.addClass("hide"),this.d.removeClass("hide"),this.dialog.close(),this.trigger("insert"));return this}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Picker",null,!0),name:"ResourcePicker",insert:function(a){a&&(this.a.val(a.id),this.c.html($("<a/>",{src:a.url,html:a.html})),this.b.addClass("hide"),this.d.removeClass("hide"),this.dialog.close(),this.trigger("insert"));return this}})})(refinery);}(window, jQuery));
