(function(window, $){'use strict';refinery.admin={ui:{},backend_path:"/"+document.location.pathname.split("/")[1]};(function(c){c.Object.create({name:"Form",module:"admin",m:function(a){var d=this,b=a.attr("href"),f,e;a={text:t("refinery.admin.form_unsaved_save_and_continue"),"class":"submit-button",click:function(){var a=d.holder,f=$(this),e=/\?[^\?]+$/,k=e.test(b)?b.match(e)[0]:"";a.trigger("before-submit");$.ajax({url:a.attr("action"),method:a.attr("method"),data:a.serialize(),dataType:"JSON"}).done(function(d,p,q){var r=q.getResponseHeader("X-XHR-Redirected-To"),n=/frontend_locale=[\w\-]+/,m=n.test(k)?k.match(n)[0]:
"";f.dialog("destroy");r?(b=r,n.test(b)?b=b.replace(n,m):e.test(b)&&""!==m?b=b+"&"+m:""!==m&&(b=b+"?"+m),Turbolinks.visit(b)):"error"===p?c.xhr.success(d,p,q,a,!0):Turbolinks.visit(b)})}};f={text:t("refinery.admin.form_unsaved_continue"),click:function(){$(this).dialog("destroy");Turbolinks.visit(b)}};e={text:t("refinery.admin.form_unsaved_cancel"),click:function(){$(this).dialog("destroy")}};$("<div/>",{html:t("refinery.admin.form_unsaved_html")}).dialog({resizable:!1,height:140,modal:!0,title:t("refinery.admin.form_unsaved_title"),
buttons:[a,f,e]})},i:function(){var a=this,d=a.holder;d.on("click",".locale-picker a",function(b){a.c!==d.serialize()&&(b.preventDefault(),b.stopPropagation(),a.m($(this)))})},k:function(){var a=this.holder,d=$("meta[name=csrf-param]").attr("content"),b=a.find('input[type="file"]');if(0<b.length)a.on("submit",function(f){f.preventDefault();f.stopPropagation();c.spinner.on();0===a.find('input[name="'+d+'"]').length&&$("<input/>",{name:d,type:"hidden",value:$("meta[name=csrf-token]").attr("content")}).appendTo(a);
a.trigger("before-submit");$.ajax(this.action,{data:a.serializeArray(),files:b,iframe:!0,processData:!1}).done(function(d,b,c){a.trigger("ajax:success",[d,b,c])}).always(function(){c.spinner.off()})})},j:function(){function a(a){a.stopPropagation()}function d(){if(b.is(":valid")){b.removeData("remote");b.removeAttr("data-remote");if(!k||k.closed)k=window.open("",g.attr("href"));b.attr({action:g.attr("href"),method:"POST",target:g.attr("href")});b.trigger("before-submit");b.on("submit",a);b.submit();
b.off("submit",a);b.attr({action:c,method:h,target:e});l&&(b.attr("data-remote",l),b.data("remote",l))}else alert("Preview is not possible because form is not filled properly!")}var b=this.holder,c=b.attr("action"),e=b.attr("target"),h=b.attr("method"),l=b.data("remote"),g=b.find(".preview-button"),k;0<g.length&&(b.on("click",".preview-button",function(a){a.preventDefault();a.stopPropagation();d()}),b.on("change","input, select, textarea",function(){k&&!k.closed&&d()}))},h:function(){var a=this,d=
a.holder,b=d.find(".form-actions .submit-button"),c;0<b.length&&(c=b.val(),d.on("change","input, select, textarea",function(){a.c!==d.serialize()&&"!"!==c[c.length]?b.val(c+" !"):b.val(c.replace(/ !$/,""))}));d.find("input.autocomplete").each(function(){var a=$(this),d,b=a.data("autocomplete");b.multiple&&(d=b.source,a.bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&a.preventDefault()}),$.extend(b,{select:function(a,d){var b=this.value.split(/,\s*/);
b.pop();b.push(d.item.value);b.push("");this.value=b.join(", ");return!1},source:function(a,b){var c=a.term.split(/,\s*/),f=c.pop(),e=d.filter(function(a){return-1===c.indexOf(a)});b($.ui.autocomplete.filter(e,f))},focus:function(){return!1}}));a.autocomplete(b)})},g:function(){function a(){var a=d.scrollTop()+d.height(),h=b.position().top;a<h?c.addClass("fly"):c.removeClass("fly")}var d=$(window),b=this.holder.find(".form-actions"),c=this.holder.find(".form-actions-left");0<this.holder.find("textarea").length&&
0<b.length&&0<c.length&&(d.on("scroll",a),this.on("destroy",function(){d.unbind("scroll",a)}),a())},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.i(),this.h(),this.k(),this.j(),this.c=a.serialize(),this.g(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});c.admin.ui.form=function(a,d){a.find("form").each(function(){d.addObject(c("admin.Form").init($(this)))})}})(refinery);(function(c){c.Object.create({name:"FormPageParts",module:"admin",e:function(){var a=this.holder.find("#page-parts-options").data("page-parts"),d,b;d='<ul class="records">';for(var c=0,e=a.length;c<e;c++)b=a[c],d+='<li data-part="'+b.name+'" class="clearfix" ><label class="stripped"><input type="checkbox"'+(b.active?' checked="1"':"")+'"> '+b.title+'</label> <span class="actions"><span class="icon-small move-icon">'+t("refinery.admin.button_move")+"</span></span></li>";return d+"</ul>"},f:function(){function a(){var a=
[],g,h;e.find("li").each(function(d){var c=$(this),e=c.data("part"),c=c.find("input").is(":checked"),f=b.find('li[aria-controls="page_part_'+e+'"]').detach(),g=$("#page_part_"+e);c?(f.removeClass("js-hide"),g.removeClass("js-hide")):(f.removeClass("ui-tabs-active ui-state-active"),f.addClass("js-hide"),g.addClass("js-hide"));g.find("input.part-active").prop("checked",c);g.find("input.part-position").val(d);"title"!==e&&(a[a.length]=f)});g=0;for(h=a.length;g<h;g++)b.append(a[g]);0===b.find(".ui-tabs-active").length&&
d.tabs({active:c.index(b.find("li:visible").first())})}var d=this.holder,b=d.find(".ui-tabs-nav"),c=b.find("li"),e=$("<div/>"),h;e.html(this.e());e.on("change","li input",a);e.find("ul").sortable({stop:a});h=[{text:t("refinery.admin.button_done"),"class":"submit-button",click:function(){a();e.dialog("close")}}];e.dialog({title:t("refinery.admin.form_page_parts_manage"),modal:!0,resizable:!0,autoOpen:!1,width:400,buttons:h});d.on("click","#page-parts-options",function(a){a.preventDefault();e.dialog("open")});
this.a=e},destroy:function(){this.is("initialised")&&this.a&&(this.a.dialog("destroy"),this.a.off(),this.a=null);return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.f(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});c.admin.ui.formPageParts=function(a,d){a.find("#page-parts").each(function(){d.addObject(c("admin.FormPageParts").init($(this)))})}})(refinery);(function(c){c.Object.create({objectConstructor:function(a,d){var b=this;c.Object.apply(b,arguments);d||(b.options.nested_sortable.stop=function(a,d){b.update(d.item)})},name:"SortableList",module:"admin",options:{nested_sortable:{p:"ul",o:"li",q:1}},set:null,html:null,b:function(a){return a.attr("id")&&/([0-9]+)$/.test(a.attr("id"))?a.attr("id").match(/([0-9]+)$/)[1]:null},update:function(a){var d=this,b=d.holder,f=b.data("update_positions_url"),e=b.nestedSortable("toArray");a={item:{id:d.b(a),prev_id:d.b(a.prev()),
next_id:d.b(a.next()),parent_id:d.b(a.parent().parent())}};d.is("updating")||JSON.stringify(e)===JSON.stringify(d.set)||(d.is({updating:!0,updated:!1}),b.nestedSortable("disable"),c.spinner.on(),$.post(f,a,function(a,f,g){"error"===f?b.html(d.html):(d.set=e,d.html=b.html());c.xhr.success(a,f,g,b);d.is("updated",!0);d.trigger("update")},"JSON").fail(function(a){b.html(d.html);c.xhr.error(a)}).always(function(){c.spinner.off();d.is("updating",!1);b.nestedSortable("enable")}));return d},destroy:function(){this.holder.nestedSortable("destroy");
this.set=null;return this._destroy()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),a.nestedSortable(this.options.nested_sortable),this.holder=a,this.set=a.nestedSortable("toArray"),this.html=a.html(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}});c.admin.ui.sortableList=function(a,d){a.find(".sortable-list").each(function(){d.addObject(c("admin.SortableList").init($(this)))})};c.Object.create({objectConstructor:function(a,d){var b=this;c.Object.apply(b,
arguments);d||(b.options.nested_sortable.stop=function(a,d){b.update(d.item)})},objectPrototype:c("admin.SortableList",{nested_sortable:{listType:"ul",handle:".move",items:"li",isAllowed:function(a,d,b){return d&&d.text()===b.parent().text()?!1:!0},maxLevels:0}},!0),name:"SortableTree"});c.admin.ui.sortableTree=function(a,d){a.find(".sortable-tree").each(function(){console.log($(this),d,"sortableTree");d.addObject(c("admin.SortableTree").init($(this)))})}})(refinery);refinery.Object.create({objectPrototype:refinery("UserInterface",{ui_modules:refinery.admin.ui},!0),module:"admin",name:"UserInterface"});(function(c){function a(a){a=$.extend(a||{},{closed:!0});c.ObjectState.call(this,a)}a.prototype={_openable:function(){return this.get("initialised")&&this.get("closed")&&!this.get("opening")},_closable:function(){return!this.get("closing")&&this.get("opened")},_loadable:function(){return!this.get("loading")&&!this.get("loaded")},_insertable:function(){return this.get("initialised")&&!this.get("inserting")}};c.extend(a.prototype,c.ObjectState.prototype);c.Object.create({name:"Dialog",module:"admin",
options:{title:"",url:null,width:710,modal:!0,autoOpen:!1,autoResize:!0},ui:null,State:a,close:function(){this.is("closable")&&this.holder.dialog("close");return this},open:function(){this.is("openable")&&(this.is("opening",!0),this.holder.dialog("open"));return this},insert:function(a){var b=a.closest(".ui-tabs-panel"),c;0<b.length&&(b=b.attr("id").replace(/-/g,"_"),"function"===typeof this[b]?c=this[b](a):a.hasClass("ui-selected")&&(c=this.l(a)));c&&this.trigger("insert",c);return this},init_buttons:function(){var a=
this,b=a.holder;b.on("click",".cancel-button, .close-button",function(b){b.preventDefault();a.close();return!1});b.on("submit","form",function(b){var c=$(this);c.attr("action")||(b.preventDefault(),b.stopPropagation(),a.insert(c))})},load:function(){var a=this,b=a.holder,f=a.options.url,e=$("#frontend_locale");if(!f)throw Error("Url isn't defined. ("+a.uid+")");a.is("loadable")&&(a.is("loading",!0),e={id:a.id,frontend_locale:0<e.length?e.val():"en"},f=$.ajax(f,e),f.fail(function(){b.html($("<div/>",
{"class":"flash error",html:t("refinery.admin.dialog_content_load_fail")}))}),f.done(function(e,f,g){"success"===f&&(b.empty(),a.d=$("<div/>").appendTo(b),c.xhr.success(e,f,g,a.d),a.n(),a.is("loaded",!0))}),f.always(function(){a.is("loading",!1);b.removeClass("loading");a.trigger("load")}));return this},n:function(){function a(){b.ui&&b.ui.destroy();b.ui=c("UserInterface",{main_content_selector:".dialog-content-wrapper"}).init(b.d);b.ui.subscribe("ui:change",a)}var b=this;a()},bind_events:function(){var a=
this,b=a.holder;a.on("insert",a.close);a.on("open",a.load);b.on("dialogopen",function(){a.is({opening:!1,opened:!0,closed:!1});a.trigger("open")});b.on("dialogbeforeclose",function(){a.is({closing:!1,closed:!0,opened:!1});a.trigger("close")});b.on("selectableselected",".records.ui-selectable",function(b,c){a.insert($(c.selected))});b.on("click",".pagination a",function(a){var d=$(this).attr("href");a.preventDefault();a.stopPropagation();$.get(d).done(function(a,d,c){b.find(".dialog-content-wrapper").trigger("ajax:success",
[a,d,c])}).always(function(){c.spinner.off()})});b.on("ajax:success",function(b,c){a.upload_area(c)})},upload_area:function(){},l:function(a){a.removeClass("ui-selected");return a.data("dialog")},destroy:function(){this.ui&&(this.ui.destroy(),this.ui=null);this.holder&&this.holder.parent().hasClass("ui-dialog")&&this.holder.dialog("destroy");return this._destroy()},init:function(){var a;this.is("initialisable")&&(this.is("initialising",!0),a=$("<div/>",{id:"dialog-"+this.id,"class":"loading"}),a.dialog(this.options),
this.holder=a,this.bind_events(),this.init_buttons(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(c){c.Object.create({name:"Picker",module:"admin",elm_current_record_id:null,elm_record_holder:null,elm_no_picked_record:null,elm_remove_picked_record:null,dialog:null,open:function(){this.getDialog().open();return this},close:function(){this.getDialog().close();return this},insert:function(a){c.log(a);return this},destroy:function(){this.dialog&&this.dialog.destroy();return this._destroy()},bind_events:function(){var a=this,c=a.holder;c.find(".current-record-link").on("click",function(b){b.preventDefault();
a.open()});c.find(".remove-picked-record").on("click",function(b){b.preventDefault();a.elm_current_record_id.val("");a.elm_record_holder.empty();a.elm_remove_picked_record.addClass("hide");a.elm_no_picked_record.removeClass("hide");a.trigger("remove")})},init_dialog:function(){},getDialog:function(){return this.dialog?this.dialog:this.init_dialog()},init:function(a){this.is("initialisable")&&(this.is("initialising",!0),this.holder=a,this.elm_current_record_id=a.find(".current-record-id"),this.elm_record_holder=
a.find(".record-holder"),this.elm_no_picked_record=a.find(".no-picked-record-selected"),this.elm_remove_picked_record=a.find(".remove-picked-record"),this.bind_events(),this.is({initialised:!0,initialising:!1}),this.trigger("init"));return this}})})(refinery);(function(c){c.Object.create({objectConstructor:function(a){a.url=c.admin.backend_path+"/dialogs/image/"+a.image_id;c.Object.apply(this,arguments)},objectPrototype:c("admin.Dialog",{title:t("refinery.admin.image_dialog_title")},!0),name:"ImageDialog",insert:function(a){var c=a.find("#image-size .ui-selected a");return this.trigger("insert",{id:a.find("#image-id").val(),alt:a.find("#image-alt").val(),size:c.data("size"),geometry:c.data("geometry"),sizes:a.find("#image-preview").data()})}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Dialog",{title:t("refinery.admin.images_dialog_title"),url:c.admin.backend_path+"/dialogs/images"},!0),name:"ImagesDialog",external_image_area:function(a){var c=a.find('input[type="url"]:valid');a=a.find('input[type="text"]:valid');var b=c.val(),f=a.val();if(b)return c.val(""),a.val(""),{url:b,alt:f}},upload_area:function(a){a.image&&(this.trigger("insert",a.image),this.holder.find("li.ui-selected").removeClass("ui-selected"),this.holder.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Dialog",{title:t("refinery.admin.links_dialog_title"),url:c.admin.backend_path+"/dialogs/links"},!0),name:"LinksDialog",email_link_area:function(a){var c=a.find("#email_address_text:valid"),b=a.find("#email_default_subject_text");a=a.find("#email_default_body_text");var f=c.val(),e=b.val(),h=a.val(),l="?",g="";if(f)return 0<e.length&&(g+=l+"subject="+encodeURIComponent(e),l="&"),0<h.length&&(g+=l+"body="+encodeURIComponent(h)),c.val(""),b.val(""),
a.val(""),{type:"email",title:f,url:"mailto:"+encodeURIComponent(f)+g}},website_link_area:function(a){var c=a.find("#web_address_text:valid");a=a.find("#web_address_target_blank");var b=c.val(),f=a.prop("checked");if(b)return c.val("http://"),a.prop("checked",!1),{type:"website",title:b.replace(/^https?:\/\//,""),url:b,blank:f}}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Dialog",{title:t("refinery.admin.resources_dialog_title"),url:c.admin.backend_path+"/dialogs/resources"},!0),name:"ResourcesDialog",upload_area:function(a){a.file&&(this.trigger("insert",a.file),this.holder.find("li.ui-selected").removeClass("ui-selected"),this.holder.find(".ui-tabs").tabs({active:0}))}})})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Picker",null,!0),name:"ImagePicker",init_dialog:function(){var a=this;a.dialog=c("admin.ImagesDialog").init().on("load",function(){a.dialog.holder.find('li[aria-controls="external-image-area"]').hide()}).on("insert",function(c){a.insert(c);a.dialog.close()});return a.dialog},insert:function(a){this.elm_current_record_id.val(a.id);this.elm_record_holder.html($("<img/>",{"class":"record size-medium",src:a.thumbnail}));this.elm_no_picked_record.addClass("hide");
this.elm_remove_picked_record.removeClass("hide");this.trigger("insert");return this}});c.admin.ui.imagePicker=function(a,d){a.find(".image-picker").each(function(){d.addObject(c("admin.ImagePicker").init($(this)))})}})(refinery);(function(c){c.Object.create({objectPrototype:c("admin.Picker",null,!0),name:"ResourcePicker",init_dialog:function(){var a=this;a.dialog=c("admin.ResourcesDialog").init().on("insert",function(c){a.insert(c);a.dialog.close()});return a.dialog},insert:function(a){var c;c=$("<span/>",{text:a.name+" - "+a.size,"class":"title"+(" "+a.ext||"")});this.elm_current_record_id.val(a.id);this.elm_record_holder.html($("<a/>",{src:a.url,html:c,"class":"record"}));this.elm_no_picked_record.addClass("hide");this.elm_remove_picked_record.removeClass("hide");
this.trigger("insert");return this}});c.admin.ui.resourcePicker=function(a,d){a.find(".resource-picker").each(function(){d.addObject(c("admin.ResourcePicker").init($(this)))})}})(refinery);}(window, jQuery));
