<% ::Refinery::Core.javascripts.each do |js| %>
<%= require_asset js %>
<% end %>

$(function () {
    var doc = $(document);

    $.ajaxSettings.dataType = 'JSON';

    function unload_ui () {
        if (refinery.PageUI) {
            refinery.PageUI.destroy();
            refinery.PageUI.unsubscribe('ui:change', reload_ui);
            refinery.PageUI = null;
        }
    }

    function reload_ui () {
        unload_ui();
        load_ui();
    }

    function load_ui () {
        refinery.PageUI = refinery('UserInterface').init($('#page'));
        refinery.PageUI.subscribe('ui:change', reload_ui);
        refinery.spinner.off();

    }

    doc.on('page:fetch', function () {
        refinery.spinner.on();
    });

    doc.on('page:receive', unload_ui);
    doc.on('page:load', load_ui);
    doc.on('page:restore', load_ui);

    doc.on('page:change', function () {
        if (window._gaq != null) {
            _gaq.push(['_trackPageview']);
        } else if (window.pageTracker != null) {
            pageTracker._trackPageview();
        }
    });

    $(window).on('beforeunload', unload_ui);

    load_ui();
});
